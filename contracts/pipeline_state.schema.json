{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://daokit.dev/contracts/pipeline_state.schema.json",
  "title": "DAOKit Pipeline State Contract",
  "description": "Canonical ledger snapshot for deterministic orchestrator state transitions.",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema_version",
    "task_id",
    "run_id",
    "goal",
    "status",
    "current_step",
    "steps",
    "role_lifecycle",
    "succession",
    "updated_at"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "1.0.0",
      "description": "Contract version for backward-safe schema evolution."
    },
    "task_id": {
      "anyOf": [
        {
          "type": "string",
          "minLength": 1
        },
        {
          "type": "null"
        }
      ],
      "description": "Stable task identifier linked to the execution plan."
    },
    "run_id": {
      "anyOf": [
        {
          "type": "string",
          "minLength": 1
        },
        {
          "type": "null"
        }
      ],
      "description": "Deterministic run identifier for a concrete task execution."
    },
    "goal": {
      "type": "string",
      "description": "Current task goal statement used by orchestrator planning and verification."
    },
    "status": {
      "type": "string",
      "enum": [
        "PLANNING",
        "ANALYSIS",
        "FREEZE",
        "EXECUTE",
        "ACCEPT",
        "DONE",
        "DRAINING",
        "BLOCKED",
        "FAILED"
      ],
      "description": "Top-level orchestrator lifecycle status."
    },
    "current_step": {
      "anyOf": [
        {
          "type": "string",
          "minLength": 1
        },
        {
          "type": "null"
        }
      ],
      "description": "Step id currently under execution, or null before dispatch starts."
    },
    "steps": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/step_contract"
      },
      "description": "Ordered step contracts compiled from requirements and design inputs."
    },
    "role_lifecycle": {
      "type": "object",
      "minProperties": 1,
      "additionalProperties": {
        "type": "string",
        "minLength": 1
      },
      "description": "Runtime status by role (for example orchestrator or worker lanes)."
    },
    "succession": {
      "$ref": "#/$defs/succession_state",
      "description": "Succession and takeover metadata for controller replacement safety."
    },
    "updated_at": {
      "type": "string",
      "format": "date-time",
      "description": "UTC timestamp of the last successful ledger mutation."
    }
  },
  "$defs": {
    "step_contract": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "id",
        "title",
        "category",
        "goal",
        "actions",
        "acceptance_criteria",
        "expected_outputs",
        "dependencies"
      ],
      "properties": {
        "id": {
          "type": "string",
          "minLength": 1,
          "description": "Stable step identifier."
        },
        "title": {
          "type": "string",
          "minLength": 1,
          "description": "Human-readable step title."
        },
        "category": {
          "type": "string",
          "minLength": 1,
          "description": "Classification used for reporting and policy checks."
        },
        "goal": {
          "type": "string",
          "minLength": 1,
          "description": "Single-sentence outcome expected from the step."
        },
        "actions": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "description": "Action list allowed for the step."
        },
        "acceptance_criteria": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "description": "Machine-reviewable criteria used to accept completion."
        },
        "expected_outputs": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "description": "Expected artifacts or files produced by this step."
        },
        "dependencies": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "description": "Upstream task or step dependencies that must be satisfied."
        }
      }
    },
    "succession_state": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "enabled",
        "last_takeover_at"
      ],
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "True when succession and lease takeover are enabled."
        },
        "last_takeover_at": {
          "anyOf": [
            {
              "type": "string",
              "format": "date-time"
            },
            {
              "type": "null"
            }
          ],
          "description": "Timestamp of the most recent successful takeover."
        }
      }
    }
  }
}
